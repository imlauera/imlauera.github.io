<!DOCTYPE html>
<html lang="es">





<head>
  <meta property="og:url" content="https://imlauera.github.io/post/letsencrypt-docker/">
  <meta property="og:site_name" content="Imlauer">
  <meta property="og:title" content="Lets Encrypt Docker">
  <meta property="og:description" content="Configurar que el servicio de docker inicie automáticamente en caso de caída o reseteo por mantenimiento https://stackoverflow.com/questions/43671482/how-to-run-docker-compose-up-d-at-system-start-up
Usando systemd: Creá un archivo en /etc/systemd/system/docker-compose-app.service con el siguiente contenido:
# /etc/systemd/system/docker-compose-app.service [Unit] Description=Docker Compose Application Service Requires=docker.service After=docker.service [Service] Type=oneshot RemainAfterExit=yes WorkingDirectory=/home/test/docker ExecStart=/usr/bin/docker compose up -d ExecStop=/usr/bin/docker compose down TimeoutStartSec=0 [Install] WantedBy=multi-user.target Cambie el parámetro WorkingDirectory con la ruta de su proyecto docker. Y habilite el servicio para que se inicie automáticamente:">
  <meta property="og:locale" content="es_es">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2023-09-20T08:59:37-03:00">
    <meta property="article:modified_time" content="2023-09-20T08:59:37-03:00">
    <meta property="article:tag" content="Docker">

  
  <meta itemprop="name" content="Lets Encrypt Docker">
  <meta itemprop="description" content="Configurar que el servicio de docker inicie automáticamente en caso de caída o reseteo por mantenimiento https://stackoverflow.com/questions/43671482/how-to-run-docker-compose-up-d-at-system-start-up
Usando systemd: Creá un archivo en /etc/systemd/system/docker-compose-app.service con el siguiente contenido:
# /etc/systemd/system/docker-compose-app.service [Unit] Description=Docker Compose Application Service Requires=docker.service After=docker.service [Service] Type=oneshot RemainAfterExit=yes WorkingDirectory=/home/test/docker ExecStart=/usr/bin/docker compose up -d ExecStop=/usr/bin/docker compose down TimeoutStartSec=0 [Install] WantedBy=multi-user.target Cambie el parámetro WorkingDirectory con la ruta de su proyecto docker. Y habilite el servicio para que se inicie automáticamente:">
  <meta itemprop="datePublished" content="2023-09-20T08:59:37-03:00">
  <meta itemprop="dateModified" content="2023-09-20T08:59:37-03:00">
  <meta itemprop="wordCount" content="785">
  <meta itemprop="keywords" content="Docker">
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Lets Encrypt Docker">
  <meta name="twitter:description" content="Configurar que el servicio de docker inicie automáticamente en caso de caída o reseteo por mantenimiento https://stackoverflow.com/questions/43671482/how-to-run-docker-compose-up-d-at-system-start-up
Usando systemd: Creá un archivo en /etc/systemd/system/docker-compose-app.service con el siguiente contenido:
# /etc/systemd/system/docker-compose-app.service [Unit] Description=Docker Compose Application Service Requires=docker.service After=docker.service [Service] Type=oneshot RemainAfterExit=yes WorkingDirectory=/home/test/docker ExecStart=/usr/bin/docker compose up -d ExecStop=/usr/bin/docker compose down TimeoutStartSec=0 [Install] WantedBy=multi-user.target Cambie el parámetro WorkingDirectory con la ruta de su proyecto docker. Y habilite el servicio para que se inicie automáticamente:">

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    
    Lets Encrypt Docker
    
  </title>
  <link rel="stylesheet" href='https://imlauera.github.io/css/site.min.css'>
  <link rel="canonical" href="https://imlauera.github.io/post/letsencrypt-docker/">
  <link rel="alternate" type="application/rss&#43;xml" href="https://imlauera.github.io/index.xml" title="Imlauer">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer">
  <meta name="author" content="Imlauer.">
  <meta name="description" content="Configurar que el servicio de docker inicie automáticamente en caso de caída o reseteo por mantenimiento
https://stackoverflow.com/questions/43671482/how-to-run-docker-compose-up-d-at-system-start-up
Usando systemd:
Creá un archivo en /etc/systemd/system/docker-compose-app.service con el siguiente contenido:
# /etc/systemd/system/docker-compose-app.service

[Unit]
Description=Docker Compose Application Service
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/home/test/docker
ExecStart=/usr/bin/docker compose up -d
ExecStop=/usr/bin/docker compose down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
Cambie el parámetro WorkingDirectory con la ruta de su proyecto docker. Y habilite el servicio para que se inicie automáticamente:">
</head>
<body><nav class="navbar is-transparent " role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a class="navbar-item" href="https://imlauera.github.io/">
      <figure class="image">
        <img alt="" class="is-rounded" src="/img/memememe.jpg">
      </figure>
    </a>
    <a class="navbar-item" href="https://imlauera.github.io/">
      Imlauer
    </a>
    <a class="navbar-item" href="/acerca/">
      Acerca de Mi
    </a>
  </div>
  
  
</nav>

  <section>
    <section class='hero is-small is-link is-fullwidth'>
      <div class="hero-body">
<div class="container">
  <h1 class="title">
    Lets Encrypt Docker
  </h1>
  <h2 class="subtitle">
    <time datetime='2023-09-20T08:59:37-03:00'>
      September 20, 2023
    </time>
    
    <br>
    
    
    
    <a class="tag is-info" href="https://imlauera.github.io/tags/docker/">Docker</a>
    
    
    
  </h2>
</div>

      </div>
    </section>
    <section class="section">
      <div class="container">
<div class="content is-medium">
  <h5 id="configurar-que-el-servicio-de-docker-inicie-automáticamente-en-caso-de-caída-o-reseteo-por-mantenimiento">Configurar que el servicio de docker inicie automáticamente en caso de caída o reseteo por mantenimiento</h5>
<p><a href="https://stackoverflow.com/questions/43671482/how-to-run-docker-compose-up-d-at-system-start-up">https://stackoverflow.com/questions/43671482/how-to-run-docker-compose-up-d-at-system-start-up</a></p>
<h4 id="usando-systemd">Usando systemd:</h4>
<p>Creá un archivo en /etc/systemd/system/docker-compose-app.service con el siguiente contenido:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># /etc/systemd/system/docker-compose-app.service</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Docker Compose Application Service
</span></span><span style="display:flex;"><span>Requires<span style="color:#f92672">=</span>docker.service
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>docker.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Type<span style="color:#f92672">=</span>oneshot
</span></span><span style="display:flex;"><span>RemainAfterExit<span style="color:#f92672">=</span>yes
</span></span><span style="display:flex;"><span>WorkingDirectory<span style="color:#f92672">=</span>/home/test/docker
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/usr/bin/docker compose up -d
</span></span><span style="display:flex;"><span>ExecStop<span style="color:#f92672">=</span>/usr/bin/docker compose down
</span></span><span style="display:flex;"><span>TimeoutStartSec<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span></code></pre></div><p>Cambie el parámetro WorkingDirectory con la ruta de su proyecto docker. Y habilite el servicio para que se inicie automáticamente:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>systemctl enable docker-compose-app
</span></span></code></pre></div><h3 id="usando-restartalways">Usando restart:always</h3>
<p>Utilice <code>restart: always</code> en su archivo <code>docker-compose.yaml</code> a cada servicio que desee reiniciar en el archivo docker-compose.yml.
<code>docker-compose up -d</code> volverá a iniciar el contenedor desde las imágenes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nginx:   
</span></span><span style="display:flex;"><span>    restart: always   
</span></span><span style="display:flex;"><span>    image: nginx   
</span></span><span style="display:flex;"><span>    ports:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;80:80&#34;</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;443:443&#34;</span>
</span></span><span style="display:flex;"><span>    links:
</span></span><span style="display:flex;"><span>      - other_container:other_container
</span></span></code></pre></div><p>Ahora si reinicías la máquina o si apagás y prendés la VPS, el servicio se levantará sólo.
<strong>Observación: Esto sólo funciona si tenés el docker.service habilitado al iniciar el sistema</strong>
Eso se hace con el siguiente comando:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo systemctl enable docker
</span></span></code></pre></div><h2 id="instalar-certbot-de-letsencrypt">Instalar certbot de LetsEncrypt</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>sudo apt update
</span></span><span style="display:flex;"><span>sudo apt install -y certbot
</span></span></code></pre></div><p>Ahora podemos ejecutar Certbot para obtener nuestro certificado. Usaremos la opción &ndash;standalone para decirle a Certbot que maneje el desafío usando su propio servidor web integrado. La opción &ndash;preferred-challenges le indica a Certbot que use el puerto 80 o el puerto 443. Si está usando el puerto 80, querrá &ndash;preferred-challenges http. Para el puerto 443 sería &ndash;preferred-challenges tls-sni. Finalmente, el indicador -d se usa para especificar el dominio para el que solicita un certificado. Puede agregar varias opciones -d para cubrir varios dominios en un solo certificado.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># http</span>
</span></span><span style="display:flex;"><span>sudo certbot certonly --standalone --preferred-challenges http -d example.com
</span></span></code></pre></div><p><a href="https://www.digitalocean.com/community/tutorials/how-to-use-certbot-standalone-mode-to-retrieve-let-s-encrypt-ssl-certificates-on-ubuntu-16-04">https://www.digitalocean.com/community/tutorials/how-to-use-certbot-standalone-mode-to-retrieve-let-s-encrypt-ssl-certificates-on-ubuntu-16-04</a></p>
<blockquote>
<p>Los certificados de Let&rsquo;s Encrypt solo son válidos por noventa días. Esto es para alentar a los usuarios a automatizar su proceso de renovación de certificados. El paquete certbot que instalamos se encarga de esto agregando un script de renovación a /etc/cron.d. Este script se ejecuta dos veces al día y renovará cualquier certificado que se encuentre dentro de los treinta días posteriores a su vencimiento.</p>
</blockquote>
<blockquote>
<p>Dado que nuestros certificados se renuevan automáticamente, todavía necesitamos una forma de ejecutar otras tareas después de una renovación. Necesitamos al menos reiniciar o recargar nuestro servidor para recoger los nuevos certificados y, como se mencionó en el Paso 3, es posible que necesitemos manipular los archivos de certificados de alguna manera para que funcionen con el software que estamos usando. Este es el propósito de la opción renew_hook de Certbot.</p>
</blockquote>
<blockquote>
<p>Para agregar un renew_hook, actualizamos el archivo de configuración de renovación de Certbot. Certbot recuerda todos los detalles de cómo obtuvo el certificado por primera vez y se ejecutará con las mismas opciones al renovarlo. Sólo necesitamos agregar nuestro gancho. Abra el archivo de configuración con su editor favorito:</p>
</blockquote>
<p><a href="https://pentacent.medium.com/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71">https://pentacent.medium.com/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71</a></p>
<h5 id="luego-de-que-se-renueva-el-certificado-automáticamente-hay-que-reiniciar-el-servidor-apache-para-que-cargue-el-nuevo-certificado-para-ello-usaremos-renew-hooks">Luego de que se renueva el certificado automáticamente hay que reiniciar el servidor Apache para que cargue el nuevo certificado para ello usaremos renew-hooks</h5>
<h2 id="una-forma-de-hacerlo-la-segunda-es-mejor">Una forma de hacerlo (la segunda es mejor)</h2>
<h4 id="letsencrypt-certbot-con-multiples-renew-hooks">LetsEncrypt certbot con multiples renew-hooks</h4>
<p><a href="https://stackoverflow.com/questions/42300579/letsencrypt-certbot-multiple-renew-hooks">https://stackoverflow.com/questions/42300579/letsencrypt-certbot-multiple-renew-hooks</a>
Si coloca algún script en la carpeta &ldquo;post&rdquo;, se ejecutará automáticamente después de la renovación. No olvide hacerlo ejecutable agregando +x al script.</p>
<p>Estoy usando solo un &ldquo;001-restart-nginx.sh&rdquo; con el siguiente contenido:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>#!/bin/bash
</span></span><span style="display:flex;"><span>echo &#34;ssl certs updated&#34; &amp;&amp; service nginx restart
</span></span></code></pre></div><p>Eso va en <code>/etc/letsencrypt/renewal-hooks/post/001-restart-nginx.sh</code></p>
<p>De esta manera, no es necesario proporcionar manualmente los parámetros &ndash;post-hook con ciertas instrucciones.</p>
<p>En el proceso de renovación real verá algo como esto:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-console" data-lang="console"><span style="display:flex;"><span>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</span></span><span style="display:flex;"><span>Congratulations, all renewals succeeded. The following certs have been renewed:
</span></span><span style="display:flex;"><span>  /etc/letsencrypt/live/&lt;your-domain-name&gt;/fullchain.pem (success)
</span></span><span style="display:flex;"><span>- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
</span></span><span style="display:flex;"><span>Running post-hook command: /etc/letsencrypt/renewal-hooks/post/001-restart-nginx.sh
</span></span><span style="display:flex;"><span>Output from post-hook command 001-restart-nginx.sh:
</span></span><span style="display:flex;"><span>ssl certs updated
</span></span></code></pre></div><h2 id="otra-forma">Otra forma</h2>
<p>También puedes configurar hooks (y otras opciones si lo deseas) como opciones globales en el archivo <code>/etc/letsencrypt/cli.ini</code> (ver documentación) de esta manera:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-console" data-lang="console"><span style="display:flex;"><span># Global config <span style="color:#66d9ef">for</span> letsencrypt runs
</span></span><span style="display:flex;"><span>#
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Note that these options apply automatically to all use of Certbot for</span>
</span></span><span style="display:flex;"><span># obtaining or renewing certificates, so options specific to a single
</span></span><span style="display:flex;"><span># certificate on a system with several certificates should not be placed
</span></span><span style="display:flex;"><span># here.
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span>renew-hook = service postfix reload
</span></span><span style="display:flex;"><span>#post-hook <span style="color:#f92672">=</span> service nginx reload
</span></span><span style="display:flex;"><span>post-hook = docker compose -f /home/test/docker/docker-compose.yml restart app
</span></span></code></pre></div><p>Primero debe crear el archivo en la mayoría de los sistemas. Letsencrypt viene sin.
También puede crear una versión específica del certificado en cada carpeta de <code>renewal</code> si no desea globalizarse.</p>

</div>


      </div>
    </section>
  </section><script 
src="/quiz/quizdown.js">
</script>
<script 
src="/quiz/quizdownKatex.js">
</script>
<script 
src="/quiz/quizdownHighlight.js">
</script>
<script>quizdown.register(quizdownHighlight).register(quizdownKatex).init()</script> 
<footer class="footer">
  <div class="content has-text-centered">
    
    
    <p>
      
      <a class="" href="https://imlauera.github.io/index.xml" target="_blank">
        <span>
          RSS
        </span>
      </a>
      
      | <a href="https://imlauera.github.io" target="_blank">Andres Imlauer.</a> 

      
      
    </p>
    
  </div>




<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]} })
</script>
</footer>


</body>
</html>
